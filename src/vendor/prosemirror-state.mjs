/* esm.sh - esbuild bundle(prosemirror-state@1.4.3) es2022 production */
import{Slice as m,Fragment as z,Mark as I,Node as P}from"prosemirror-model";import{ReplaceStep as W,ReplaceAroundStep as K,Transform as L}from"prosemirror-transform";var O=Object.create(null),l=class{constructor(e,t,r){this.$anchor=e,this.$head=t,this.ranges=r||[new N(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=m.empty){let r=t.content.lastChild,n=null;for(let a=0;a<t.openEnd;a++)n=r,r=r.lastChild;let i=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:c,$to:u}=o[a],h=e.mapping.slice(i);e.replaceRange(h.map(c.pos),h.map(u.pos),a?m.empty:t),a==0&&b(e,i,(r?r.isInline:n&&n.isTextblock)?-1:1)}}replaceWith(e,t){let r=e.steps.length,n=this.ranges;for(let i=0;i<n.length;i++){let{$from:o,$to:a}=n[i],c=e.mapping.slice(r),u=c.map(o.pos),h=c.map(a.pos);i?e.deleteRange(u,h):(e.replaceRangeWith(u,h,t),b(e,r,t.isInline?-1:1))}}static findFrom(e,t,r=!1){let n=e.parent.inlineContent?new g(e):S(e.node(0),e.parent,e.pos,e.index(),t,r);if(n)return n;for(let i=e.depth-1;i>=0;i--){let o=t<0?S(e.node(0),e.node(i),e.before(i+1),e.index(i),t,r):S(e.node(0),e.node(i),e.after(i+1),e.index(i)+1,t,r);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new d(e.node(0))}static atStart(e){return S(e,e,0,0,1)||new d(e)}static atEnd(e){return S(e,e,e.content.size,e.childCount,-1)||new d(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let r=O[t.type];if(!r)throw new RangeError(`No selection type ${t.type} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in O)throw new RangeError("Duplicate use of selection JSON ID "+e);return O[e]=t,t.prototype.jsonID=e,t}getBookmark(){return g.between(this.$anchor,this.$head).getBookmark()}};l.prototype.visible=!0;var N=class{constructor(e,t){this.$from=e,this.$to=t}},R=!1;function T(s){!R&&!s.parent.inlineContent&&(R=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+s.parent.type.name+")"))}var g=class s extends l{constructor(e,t=e){T(e),T(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let r=e.resolve(t.map(this.head));if(!r.parent.inlineContent)return l.near(r);let n=e.resolve(t.map(this.anchor));return new s(n.parent.inlineContent?n:r,r)}replace(e,t=m.empty){if(super.replace(e,t),t==m.empty){let r=this.$from.marksAcross(this.$to);r&&e.ensureMarks(r)}}eq(e){return e instanceof s&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new k(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new s(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,r=t){let n=e.resolve(t);return new this(n,r==t?n:e.resolve(r))}static between(e,t,r){let n=e.pos-t.pos;if((!r||n)&&(r=n>=0?1:-1),!t.parent.inlineContent){let i=l.findFrom(t,r,!0)||l.findFrom(t,-r,!0);if(i)t=i.$head;else return l.near(t,r)}return e.parent.inlineContent||(n==0?e=t:(e=(l.findFrom(e,-r,!0)||l.findFrom(e,r,!0)).$anchor,e.pos<t.pos!=n<0&&(e=t))),new s(e,t)}};l.jsonID("text",g);var k=class s{constructor(e,t){this.anchor=e,this.head=t}map(e){return new s(e.map(this.anchor),e.map(this.head))}resolve(e){return g.between(e.resolve(this.anchor),e.resolve(this.head))}},p=class s extends l{constructor(e){let t=e.nodeAfter,r=e.node(0).resolve(e.pos+t.nodeSize);super(e,r),this.node=t}map(e,t){let{deleted:r,pos:n}=t.mapResult(this.anchor),i=e.resolve(n);return r?l.near(i):new s(i)}content(){return new m(z.from(this.node),0,0)}eq(e){return e instanceof s&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new J(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new s(e.resolve(t.anchor))}static create(e,t){return new s(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}};p.prototype.visible=!1;l.jsonID("node",p);var J=class s{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:r}=e.mapResult(this.anchor);return t?new k(r,r):new s(r)}resolve(e){let t=e.resolve(this.anchor),r=t.nodeAfter;return r&&p.isSelectable(r)?new p(t):l.near(t)}},d=class s extends l{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=m.empty){if(t==m.empty){e.delete(0,e.doc.content.size);let r=l.atStart(e.doc);r.eq(e.selection)||e.setSelection(r)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new s(e)}map(e){return new s(e)}eq(e){return e instanceof s}getBookmark(){return U}};l.jsonID("all",d);var U={map(){return this},resolve(s){return new d(s)}};function S(s,e,t,r,n,i=!1){if(e.inlineContent)return g.create(s,t);for(let o=r-(n>0?0:1);n>0?o<e.childCount:o>=0;o+=n){let a=e.child(o);if(a.isAtom){if(!i&&p.isSelectable(a))return p.create(s,t-(n<0?a.nodeSize:0))}else{let c=S(s,a,t+n,n<0?a.childCount:0,n,i);if(c)return c}t+=a.nodeSize*n}return null}function b(s,e,t){let r=s.steps.length-1;if(r<e)return;let n=s.steps[r];if(!(n instanceof W||n instanceof K))return;let i=s.mapping.maps[r],o;i.forEach((a,c,u,h)=>{o==null&&(o=h)}),s.setSelection(l.near(s.doc.resolve(o),t))}var A=1,y=2,F=4,E=class extends L{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|A)&~y,this.storedMarks=null,this}get selectionSet(){return(this.updated&A)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=y,this}ensureMarks(e){return I.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&y)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~y,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let r=this.selection;return t&&(e=e.mark(this.storedMarks||(r.empty?r.$from.marks():r.$from.marksAcross(r.$to)||I.none))),r.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,r){let n=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(n.text(e),!0):this.deleteSelection();{if(r==null&&(r=t),r=r??t,!e)return this.deleteRange(t,r);let i=this.storedMarks;if(!i){let o=this.doc.resolve(t);i=r==t?o.marks():o.marksAcross(this.doc.resolve(r))}return this.replaceRangeWith(t,r,n.text(e,i)),this.selection.empty||this.setSelection(l.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=F,this}get scrolledIntoView(){return(this.updated&F)>0}};function D(s,e){return!e||!s?s:s.bind(e)}var f=class{constructor(e,t,r){this.name=e,this.init=D(t.init,r),this.apply=D(t.apply,r)}},V=[new f("doc",{init(s){return s.doc||s.schema.topNodeType.createAndFill()},apply(s){return s.doc}}),new f("selection",{init(s,e){return s.selection||l.atStart(e.doc)},apply(s){return s.selection}}),new f("storedMarks",{init(s){return s.storedMarks||null},apply(s,e,t,r){return r.selection.$cursor?s.storedMarks:null}}),new f("scrollToSelection",{init(){return 0},apply(s,e){return s.scrolledIntoView?e+1:e}})],w=class{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=V.slice(),t&&t.forEach(r=>{if(this.pluginsByKey[r.key])throw new RangeError("Adding different instances of a keyed plugin ("+r.key+")");this.plugins.push(r),this.pluginsByKey[r.key]=r,r.spec.state&&this.fields.push(new f(r.key,r.spec.state,r))})}},x=class s{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let r=0;r<this.config.plugins.length;r++)if(r!=t){let n=this.config.plugins[r];if(n.spec.filterTransaction&&!n.spec.filterTransaction.call(n,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],r=this.applyInner(e),n=null;for(;;){let i=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let c=n?n[o].n:0,u=n?n[o].state:this,h=c<t.length&&a.spec.appendTransaction.call(a,c?t.slice(c):t,u,r);if(h&&r.filterTransaction(h,o)){if(h.setMeta("appendedTransaction",e),!n){n=[];for(let M=0;M<this.config.plugins.length;M++)n.push(M<o?{state:r,n:t.length}:{state:this,n:0})}t.push(h),r=r.applyInner(h),i=!0}n&&(n[o]={state:r,n:t.length})}}if(!i)return{state:r,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new s(this.config),r=this.config.fields;for(let n=0;n<r.length;n++){let i=r[n];t[i.name]=i.apply(e,this[i.name],this,t)}return t}get tr(){return new E(this)}static create(e){let t=new w(e.doc?e.doc.type.schema:e.schema,e.plugins),r=new s(t);for(let n=0;n<t.fields.length;n++)r[t.fields[n].name]=t.fields[n].init(e,r);return r}reconfigure(e){let t=new w(this.schema,e.plugins),r=t.fields,n=new s(t);for(let i=0;i<r.length;i++){let o=r[i].name;n[o]=this.hasOwnProperty(o)?this[o]:r[i].init(e,n)}return n}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(r=>r.toJSON())),e&&typeof e=="object")for(let r in e){if(r=="doc"||r=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let n=e[r],i=n.spec.state;i&&i.toJSON&&(t[r]=i.toJSON.call(n,this[n.key]))}return t}static fromJSON(e,t,r){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let n=new w(e.schema,e.plugins),i=new s(n);return n.fields.forEach(o=>{if(o.name=="doc")i.doc=P.fromJSON(e.schema,t.doc);else if(o.name=="selection")i.selection=l.fromJSON(i.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(i.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(r)for(let a in r){let c=r[a],u=c.spec.state;if(c.key==o.name&&u&&u.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){i[o.name]=u.fromJSON.call(c,e,t[a],i);return}}i[o.name]=o.init(e,i)}}),i}};function $(s,e,t){for(let r in s){let n=s[r];n instanceof Function?n=n.bind(e):r=="handleDOMEvents"&&(n=$(n,e,{})),t[r]=n}return t}var C=class{constructor(e){this.spec=e,this.props={},e.props&&$(e.props,this,this.props),this.key=e.key?e.key.key:q("plugin")}getState(e){return e[this.key]}},v=Object.create(null);function q(s){return s in v?s+"$"+ ++v[s]:(v[s]=0,s+"$")}var B=class{constructor(e="key"){this.key=q(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}};export{d as AllSelection,x as EditorState,p as NodeSelection,C as Plugin,B as PluginKey,l as Selection,N as SelectionRange,g as TextSelection,E as Transaction};
//# sourceMappingURL=prosemirror-state.mjs.map